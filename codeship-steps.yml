- type: parallel
  steps:
  - name: Run tests
    service: api
    command: bin/ci rspec
  - name: Run Rubocop
    service: api
    command: rubocop
- name: Push to AWS ECR
  type:
    - serial
    - push
  tag: ^dev|master$
  image_name: 457201446358.dkr.ecr.eu-central-1.amazonaws.com/hqtrust-core-api
  registry: 457201446358.dkr.ecr.eu-central-1.amazonaws.com
  dockercfg_service: dockercfg-generator
  steps:
    - service: api
      tag: ^dev|master$
      image_tag: "commit-{{.CommitID}}"
    - service: api
      tag: ^dev$
      image_tag: "dev"
    - service: api
      tag: ^master$
      image_tag: "master"
- name: Deploy to dev Kubernetes cluster
  tag: ^dev$
  service: deploy-dev
  command: bin/deploy
- name: Deploy to prod Kubernetes cluster
  tag: ^master$
  service: deploy-prod
  command: bin/deploy
